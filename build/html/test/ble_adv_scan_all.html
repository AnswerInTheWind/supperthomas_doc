

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BLE 广播-(1) &mdash; supperthomas_wiki 0.0.1 文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Nordic" href="../nordic/nordic_nrf5x.html" />
    <link rel="prev" title="Welcome to supperthomas_wiki’s documentation!" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> supperthomas_wiki
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">BLE 广播-(1)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">1. 基本知识介绍</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">1.1 基本概念</a></li>
<li class="toctree-l3"><a class="reference internal" href="#core-spec">1.2 core spec的内容</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">1.3 基本理解</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adv-data">2. 广播内容（adv data）</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hci-adv">3. 广播参数和HCI 命令（ADV）</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adv-enable">3.1 adv enable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#set-adv-data">3.2 set adv data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#set-adv-param">3.3 set adv param</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">5. 空中传输</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">5.2 set adv param举例：</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">6. 广播的种类</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adv-ind">6.1 ADV_IND</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adv-direct-ind">6.2 ADV_DIRECT_IND</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adv-nonconn-ind">6.3 ADV_NONCONN_IND</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scan-req">6.4 SCAN_REQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scan-response">6.5 SCAN_RESPONSE</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#beacon">7. beacon</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ibeacon">7.1 Ibeacon</a></li>
<li class="toctree-l3"><a class="reference internal" href="#altbeacon">7.2 Altbeacon</a></li>
<li class="toctree-l3"><a class="reference internal" href="#eddystone">7.3 eddystone</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#ble-2">BLE 扫描（2）</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#scan">8. 主机scan扫描</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scanhci-event">8.1 scan相关的HCI 命令和event</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#scan-enable">8.1.1 scan enable</a></li>
<li class="toctree-l4"><a class="reference internal" href="#set-scan-data">8.1.2 set scan data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#set-scan-param">8.1.3 set scan param</a></li>
<li class="toctree-l4"><a class="reference internal" href="#event-le-adv-report">8.1.4 EVENT  LE adv report</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">8.2  SCAN 类型</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#passive-scan">8.2.1 被动扫描（passive scan）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#active-scan">8.2.2 主动扫描（Active scan）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">8.3 SCAN 参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mesh">8.4 mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ble-5-0-ble-4-0">8.4 ble 5.0 &amp; ble 4.0</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../nordic/nordic_nrf5x.html">Nordic</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">supperthomas_wiki</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>BLE 广播-(1)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/test/ble_adv_scan_all.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ble-1">
<h1>BLE 广播-(1)<a class="headerlink" href="#ble-1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>1. 基本知识介绍<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>查看本篇文章，大家可以知道以下内容：</p>
<ul class="simple">
<li><p>ble是如何打广播的，让对方发现自己的。</p></li>
<li><p>广播数据如何修改</p></li>
</ul>
<div class="section" id="id2">
<h3>1.1 基本概念<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>BLE的物理层这边简单提一些。</p>
<p><img alt="image-20200809075550817" src="../_images/adv_channel.png" /></p>
<p>ble的信道和BR/EDR的信道是完全不一样的。但是范围是相同的，差不多也都是2.4Ghz的频道。可以简单理解为空中有40个信道0~39信道。两个设备在相同的信道里面可以进行相互通信。</p>
<p>而这些信道SIG又重新编号：</p>
<p><img alt="image-20200809080104054" src="../_images/adv_channel2.png" /></p>
<p>这个编号就是把37 38 39。 3个信道抽出来，作为广播信道，其他都是数据信道。这篇文章主要讲广播，所以基本数据信息都是围绕37 38 39这三个信道上面的通信来讲的。</p>
<p>我们可以看到这3个信道是分散排列的。大家可以思考下为什么。</p>
<p>其实看下面一张图就知道了。</p>
<p><img alt="image-20200809080327101" src="../_images/wifi_channel.png" /></p>
</div>
<div class="section" id="core-spec">
<h3>1.2 core spec的内容<a class="headerlink" href="#core-spec" title="永久链接至标题">¶</a></h3>
<p>本文所讲的内容主要在</p>
<p>BLUETOOTH CORE SPECIFICATION Version 5.2 | Vol 6, Part B</p>
<p>2.3 ADVERTISING PHYSICAL CHANNEL PDU</p>
<p>章节中，想要仔细研究的可以研究该章节，本文会将比较常用的内容展示给大家。</p>
<p>GAP中也有部分定义广播相关的内容</p>
<p>BLUETOOTH CORE SPECIFICATION Version 5.2 | Vol 3, Part C</p>
<p>9 OPERATIONAL MODES AND PROCEDURES – LE
PHYSICAL TRANSPORT</p>
</div>
<div class="section" id="id3">
<h3>1.3 基本理解<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>我们使用手机蓝牙通常会搜索设备。搜到的设备有两种，ble和BR/EDR的设备，BR/EDR是和 经典蓝牙相关的，本文今天不介绍，下面来介绍ble相关的操作。其实仔细思考一下手机搜索ble设备的时候，手机其实就充当一个观察者（observer），ble设备其实就是一个广播者（broadcaster)。</p>
<p>大家可以用手机下载一个apk应用，nrf connect.apk。苹果手机，可以使用lightblue</p>
<p>![image-20200809080327101](picture/nrf connect.jpg)</p>
</div>
</div>
<div class="section" id="adv-data">
<h2>2. 广播内容（adv data）<a class="headerlink" href="#adv-data" title="永久链接至标题">¶</a></h2>
<p>我们先来理解一下最基本的广播ADV_IND</p>
<p><img alt="image-20200809082451637" src="../_images/ADV_IND.png" /></p>
<p>这张图的大概意思是：ADV_IND广播有两部分组成，1. 广播地址（就是广播者的地址，占6个字节）2. 广播数据（0-31个字节）（今天讲的主要内容一共就31个字节，听起来是不是很简单）</p>
<p>从上面nrf connect的软件中可以看到蓝牙地址，这个地址就是广播的地址，其他的所有你能看到的内容都在后面的31个字节里面。如果能理解这31个字节的内容，基本上你就可以熟练的使用蓝牙广播功能了。</p>
<p>这31个字节里面内容，</p>
<p><img alt="image-20200809084151585" src="../_images/adv_data.png" /></p>
<p><img alt="image-20200809084242675" src="../_images/adv_data2.png" /></p>
<p>图中的data就是31个byte。</p>
<p>这个adv_data中都是由一个一个的小元素组成的。称之为AD Structure。</p>
<p>每个元素里面有两个要素：1. 长度（length)， 2. 数据(data)</p>
<p>每个数据里面又包含两个元素：1. 类型（type), 2. 数据</p>
<p>总结一下就是一个L T V模型（length， type， data）</p>
<p>这个length代表的是后面数据有多长，不包含length的长度。</p>
<p>我们拿一个常见的广播数据来讲一下即可。</p>
<p>这个广播数据可以用nrf connect 来获取。</p>
<p><img alt="image-20200809094557087" src="../_images/adv1.png" /></p>
<p>点击RAW，可以看到数据：</p>
<p><img alt="image-20200809094638230" src="../_images/adv2.png" /></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="mh">0x02</span> <span class="mh">0x01</span> <span class="mh">0x1a</span> 
<span class="mh">0x04</span> <span class="mh">0x09</span> <span class="mh">0x62</span> <span class="mh">0x6c</span> <span class="mh">0x65</span>
<span class="mh">0x02</span> <span class="mh">0x0a</span> <span class="mh">0xf9</span>
</pre></div>
</div>
<p>这里面一共放了3个信息。</p>
<p>第一个byte是长度，第二个byte是ad type。</p>
<p>这边可能你就要像知道ad type到底是什么意思呢？</p>
<p>其实软件已经帮您解释出来了。而且core spec里面其实也没有ad type是什么意思的完全解释。</p>
<p>记住这点，core spec里面没有解释。</p>
<p>那哪里有呢？其实细心一点你可以发现：</p>
<p><img alt="image-20200809095128928" src="../_images/adv_type.png" /></p>
<p>这个网址比较旧了。https://www.bluetooth.com/specifications/assigned-numbers/generic-access-profile/</p>
<p>可以访问这个网址。</p>
<p><img alt="image-20200809095451137" src="../_images/ad_type.png" /></p>
<p>我们这里看到了0x01代表的是flags。而这个flags里面值代表什么含义呢？</p>
<p>后面提供了索引信息(但是这个索引信息有一些旧了，建议大家不用参考)。</p>
<p>主要参考一份文档</p>
<p>这个文档中有所有AD TYPE的类型描述，下面我就简单讲下上面所提到的3个常用的AD TYPE</p>
<ul>
<li><p>0x01 FLAGS</p>
<p>这个是标志该设备是哪一种类型的，有LE 和BR/EDR NOT SUPPORT是常见的，其他的不太常用，这个值也不太常需要改变</p>
</li>
</ul>
<p><img alt="image-20200809095906245" src="../_images/FLAGS.png" /></p>
<ul>
<li><p>0x09  complelte local name</p>
<p><img alt="image-20200809100457300" src="../_images/ad_type2.png" /></p>
</li>
</ul>
<p>这个现实的是名称，就是你要给手机显示的名字，后面3个byte ascii就是“ble”</p>
<p>所以app上面会显示该名称，这个也不用查手册，后面就是具体的名称，长度在第一个字节0x04里面有体现</p>
<ul>
<li><p>0x0a  tx power level</p>
<p><img alt="image-20200809100812848" src="../_images/tx_power.png" /></p>
</li>
</ul>
<p>![image-20200809100844900](./picture/tx power2.png)</p>
<p>这里面就很明显了，上面那个值是0xF9 代表的是-7dm（这个是补码显示的）</p>
<p>在app上面也有体现：</p>
<p><img alt="image-20200809101130669" src="../_images/txpower2.png" /></p>
<p>熟悉了上面的内容，基本就可以知道广播内容是如何显示，以及31个字节是如何写的了，这个相当于是应用层，接下来，会深入介绍协议栈层是如何设置之类的。</p>
</div>
<div class="section" id="hci-adv">
<h2>3. 广播参数和HCI 命令（ADV）<a class="headerlink" href="#hci-adv" title="永久链接至标题">¶</a></h2>
<p>​          上面讲到了广播内容的设定，但是这些内容要怎么展现呢？这就需要了解本章节了。</p>
<div class="section" id="adv-enable">
<h3>3.1 adv enable<a class="headerlink" href="#adv-enable" title="永久链接至标题">¶</a></h3>
<p>​        先讲一下这个是能命令，有了这个命令就可以开始打广播了</p>
<p>![image-20200809151314184](./picture/adv enable.png)</p>
<p>这个命令有一个参数，</p>
<p>![image-20200809151339362](./picture/adv enable param.png)</p>
<p>有了这个命令你就可以打广播了，广播内容可能为空也可能是默认值，不管如何，总之有了这一条命令你就可以控制是否开始打广播了。</p>
<p><img alt="image-20200809151646319" src="../_images/airlog.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">01</span> <span class="mi">0</span><span class="n">a</span> <span class="mi">20</span> <span class="mi">01</span> <span class="mi">01</span>
</pre></div>
</div>
<p>通过HCI 给卡片发这条命令，就可以用nrf connect扫描看到设备了。</p>
</div>
<div class="section" id="set-adv-data">
<h3>3.2 set adv data<a class="headerlink" href="#set-adv-data" title="永久链接至标题">¶</a></h3>
<p>​       设置广播数据内容</p>
<p>![image-20200809152243790](./picture/set adv data.png)</p>
<p>参数：</p>
<p>![image-20200809152316460](./picture/set adv param .png)</p>
<p>这个也很好理解，就是上一章讲到的广播内容（adv data），这个就是设置广播内容的命令。参数就是内容的长度和内容的数据，最大也就31个字节。</p>
</div>
<div class="section" id="set-adv-param">
<h3>3.3 set adv param<a class="headerlink" href="#set-adv-param" title="永久链接至标题">¶</a></h3>
<p>这个广播参数就相对来说比较复杂一些了，不过可以先留个印象，后面看空气包的时候可以结合一起来看。</p>
<p>命令：</p>
<p>![image-20200809152750407](./picture/adv param.png)</p>
<p>参数：</p>
<p><img alt="image-20200809152830009" src="../_images/image-20200809152830009.png" /></p>
<p>![image-20200809153236345](./picture/adv param2.png)</p>
<p>这个实在是太多了，我就不一一讲了，记住这边会有一个很多的参数，后面讲空气包的时候会联系到这边一起讲。</p>
<p>最主要的理解这3个就可以了，可能还有一些其他连带的命令，比如tx power之类的，其他的都是协议栈内容。</p>
</div>
</div>
<div class="section" id="id4">
<h2>5. 空中传输<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>![image-20200809163421555](./picture/air log.png)</p>
<p>当发送命令adv enable的时候，蓝牙卡片就会在3个通道（37， 38，39）上发送数据，其实就是在3个通道上面发送数据，发送的数据就是这个广播什么类型，以及广播内容（就是上面讲到的adv data）</p>
<p>在空气中，这个包空气中如何发送，以及以多大的间隔发送，都是根据set adv param。</p>
<div class="section" id="id5">
<h3>5.2 set adv param举例：<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>我们来举个例子看看</p>
<p><img alt="image-20200809203905853" src="../_images/adv_param.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adv</span> <span class="n">intreval</span> <span class="nb">min</span><span class="p">:</span> <span class="mi">30</span><span class="n">ms</span><span class="p">(</span><span class="mi">48</span> <span class="n">slot</span><span class="p">)</span>
<span class="n">adv</span> <span class="n">interval</span> <span class="nb">max</span><span class="p">:</span> <span class="mi">60</span><span class="n">ms</span><span class="p">(</span><span class="mi">96</span> <span class="n">slot</span><span class="p">)</span>
<span class="n">adv</span> <span class="nb">type</span> <span class="p">:</span> <span class="n">connectable</span> <span class="n">undirected</span> <span class="n">advertising</span>
<span class="n">own</span> <span class="n">address</span> <span class="nb">type</span><span class="p">:</span> <span class="n">public</span>
<span class="n">direct</span> <span class="n">address</span> <span class="nb">type</span><span class="p">:</span> <span class="n">public</span>
<span class="n">direct</span> <span class="n">address</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">adv</span> <span class="n">channel</span> <span class="nb">map</span><span class="p">:</span> <span class="mi">37</span> <span class="mi">38</span> <span class="mi">39</span> <span class="n">enable</span>
<span class="n">adv</span> <span class="nb">filter</span> <span class="n">policy</span><span class="p">:</span> <span class="n">scan</span> <span class="n">request</span> <span class="kn">from</span> <span class="nn">any</span><span class="p">,</span><span class="n">connect</span> <span class="n">request</span> <span class="kn">from</span> <span class="nn">any</span>
</pre></div>
</div>
<p>看下时间间隔</p>
<p><img alt="image-20200809204826865" src="../_images/adv_interval.png" /></p>
<p>简单理解一下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1. adv interval 这个是指示的每次发送广播的时间间隔，这边设置的是30~60ms，从空中看有一次是33ms，就是发送广播的时间间隔，看上去也是符合的。
2. adv type： 这个是广播类型，不同的广播类型，发送的广播类型不一样，主机认识的类型也不一样，下一个章节会介绍一些常见的类型，
3. own address type: 本机的蓝牙地址类型，public的，这个涉及到蓝牙地址类型的知识，不展开了。
4. direct adress: 发送direct广播的时候需要参考这个地址，也分类型和地址
5. adv channel: 这个就是37 38 39 需要在哪几个通道里面，基本上默认都是全通道打的。
6. adv filter policy： 这个就是响应哪些请求。
</pre></div>
</div>
<p>通常我们常用的就是adv interval，这个可以控制打广播的时间间隔，具体每次打的时间间隔底层根据范围随机来设置的。控制这个时间间隔可以降低打广播时候的功耗。</p>
</div>
</div>
<div class="section" id="id6">
<h2>6. 广播的种类<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>介绍几种常用的广播类型，这个涉及到的参数就是adv param中的adv type</p>
<div class="section" id="adv-ind">
<h3>6.1 ADV_IND<a class="headerlink" href="#adv-ind" title="永久链接至标题">¶</a></h3>
<p>​    这个比较常用的，可以连接的，非定向的，任何设备都可以搜到的。</p>
</div>
<div class="section" id="adv-direct-ind">
<h3>6.2 ADV_DIRECT_IND<a class="headerlink" href="#adv-direct-ind" title="永久链接至标题">¶</a></h3>
<p>​    定向广播，这个就只能特定设备才能搜到该广播，也就是地址是direct address的设备才能搜到该广播，（实际上空气中还是会有的，只是对端HOST不会上报）</p>
</div>
<div class="section" id="adv-nonconn-ind">
<h3>6.3 ADV_NONCONN_IND<a class="headerlink" href="#adv-nonconn-ind" title="永久链接至标题">¶</a></h3>
<p>​     非定向不可连接的广播，这个就是告诉对端，该设备不可连接，在nrf connect上面也会看到设备是没有connect按钮的。</p>
</div>
<div class="section" id="scan-req">
<h3>6.4 SCAN_REQ<a class="headerlink" href="#scan-req" title="永久链接至标题">¶</a></h3>
<p>​        这个也是一种广播，不过这种广播是请求对端的scan response data， scan response 数据可以理解成广播数据的补充。可以不同，也可以相同。</p>
</div>
<div class="section" id="scan-response">
<h3>6.5 SCAN_RESPONSE<a class="headerlink" href="#scan-response" title="永久链接至标题">¶</a></h3>
<p>​         这个和6.4相对应，作为回应，回复的也是scan response的数据。有些重要的数据可以放到scan req中，非重要的数据可以放到sccan response中。</p>
</div>
</div>
<div class="section" id="beacon">
<h2>7. beacon<a class="headerlink" href="#beacon" title="永久链接至标题">¶</a></h2>
<p>其实对于协议栈来说，发什么广播数据都不用关心。31个byte怎么传输都可以，所以这个beacon相对来说，当需要开发相应的应用的时候需要非常了解，不开发的话也可以不用了解，这个我确实也不是特别了解里面的内容，大部分自成体系的。我就摘抄网上讲的比较好的记录一下：</p>
<p>​       目前主流的三种帧格式分别为苹果公司的iBeacon，Radius Networks公司的AltBeacon以及谷歌公司的Eddystone。</p>
<div class="section" id="ibeacon">
<h3>7.1 Ibeacon<a class="headerlink" href="#ibeacon" title="永久链接至标题">¶</a></h3>
<p>iBeacon使用了称为厂商数据字段的标准AD Type结构。如下图所示，为iBeacon的广播包，按AD Type结构进行分割如下：</p>
<p><img alt="image-20200809214435745" src="../_images/ibeacon.png" /></p>
<p><img alt="image-20200809214514505" src="../_images/ibeacon2.png" /></p>
<p>厂商数据字段的数据域前2字节为公司识别码。由蓝牙SIG组织分配给各公司，指示后续数据的解码方式。在上图中，0x004C为苹果公司的ID。0x02指明该设备为“proximity  beacon”，该值在iBeacon设备中均为0x02。UUID指明拥有该beacon设备的机构。主次字段用来编码位置信息，通常主字段指明某个建筑，而次字段指明在这栋建筑中的特定位置。例如“伦敦中心商场，运动产品区”。发送功率字段帮助应用进行距离估算。有关iBeacon的详细内容可以参考<a class="reference external" href="https://developer.apple.com/ibeacon/Getting-Started-with-iBeacon.pdf">Getting started with iBeacon</a></p>
</div>
<div class="section" id="altbeacon">
<h3>7.2 Altbeacon<a class="headerlink" href="#altbeacon" title="永久链接至标题">¶</a></h3>
<p><img alt="image-20200809214726387" src="../_images/altbeacon.png" /></p>
</div>
<div class="section" id="eddystone">
<h3>7.3 eddystone<a class="headerlink" href="#eddystone" title="永久链接至标题">¶</a></h3>
<p>谷歌公司的Eddystone与iBeacon及AltBeacon有所不同。它没用使用所谓的厂商数据字段，而是使用16位服务UUID字段以及服务数据字段。Eddystone还定义了如下图所示的子类型，具体内容可以参考<a class="reference external" href="https://github.com/google/eddystone">eddystone</a>：</p>
<p><img alt="image-20200809214805335" src="../_images/eddyston.png" /></p>
<p>这边提供一个blog供需要的人参考吧。</p>
<p>https://blog.csdn.net/bi_jian/article/details/82927904</p>
<p>可以这样理解，其实beacon的一些应用不太需要协议栈的一些链路内容，只要可以打广播即可。</p>
</div>
</div>
</div>
<div class="section" id="ble-2">
<h1>BLE 扫描（2）<a class="headerlink" href="#ble-2" title="永久链接至标题">¶</a></h1>
<div class="section" id="scan">
<h2>8. 主机scan扫描<a class="headerlink" href="#scan" title="永久链接至标题">¶</a></h2>
<p>通常扫描是作为主机端来控制的，就是我们通常的手机端，所以这部分放到最后，可能只做丛机有不需要了解下面的内容。</p>
<div class="section" id="scanhci-event">
<h3>8.1 scan相关的HCI 命令和event<a class="headerlink" href="#scanhci-event" title="永久链接至标题">¶</a></h3>
<p>跟上面广播命令相对应。</p>
<div class="section" id="scan-enable">
<h4>8.1.1 scan enable<a class="headerlink" href="#scan-enable" title="永久链接至标题">¶</a></h4>
<p>这个命令就是扫描的开关了，打开扫描，</p>
<p>![image-20200810211520195](./picture/scan enable.png)</p>
<p>两个参数：</p>
<ul>
<li><p>scan enable</p>
<p>![image-20200810211603006](./picture/scan enable2.png)</p>
</li>
<li><p>filter_dumplicate</p>
<p>这个参数就是是否过滤重复的信息，默认是打开的，如果不打开，scan到一次就会上报一次，不过滤重复地址。</p>
<p><img alt="image-20200810211727398" src="../_images/filter_dumplicate.png" /></p>
</li>
</ul>
</div>
<div class="section" id="set-scan-data">
<h4>8.1.2 set scan data<a class="headerlink" href="#set-scan-data" title="永久链接至标题">¶</a></h4>
<p>这个和上面的adv data内容差不多</p>
<p>![image-20200810211924445](./picture/scan data.png)</p>
</div>
<div class="section" id="set-scan-param">
<h4>8.1.3 set scan param<a class="headerlink" href="#set-scan-param" title="永久链接至标题">¶</a></h4>
<p>参数和adv param类似：</p>
<p>![image-20200810212145243](./picture/scan param.png)</p>
</div>
<div class="section" id="event-le-adv-report">
<h4>8.1.4 EVENT  LE adv report<a class="headerlink" href="#event-le-adv-report" title="永久链接至标题">¶</a></h4>
<p>做扫描，扫描到设备的时候，会上报该条event</p>
<p>![image-20200810213335491](./picture/adv report event.png)</p>
<p>这个里面有以下参数：</p>
<p>![image-20200810213555256](./picture/repo param.png)</p>
</div>
</div>
<div class="section" id="id7">
<h3>8.2  SCAN 类型<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>scan分为Passive scan和Active scan</p>
<div class="section" id="passive-scan">
<h4>8.2.1 被动扫描（passive scan）<a class="headerlink" href="#passive-scan" title="永久链接至标题">¶</a></h4>
<p>![image-20200810212526908](./picture/passive scan.png)</p>
<p>被动扫描，这个主要看上面这个流程，对方发广播了，扫描到了，就回报给host。</p>
</div>
<div class="section" id="active-scan">
<h4>8.2.2 主动扫描（Active scan）<a class="headerlink" href="#active-scan" title="永久链接至标题">¶</a></h4>
<p>![image-20200810212942242](./picture/active scan.png)</p>
<p>这个主动扫描，就是开启扫描之后，如果搜到了广播，发送SCAN_REQ请求，之后搜到SCAN_RSP之后再上报信息。</p>
</div>
</div>
<div class="section" id="id8">
<h3>8.3 SCAN 参数<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>scan在空气中实际上是不太能看到的，因为主机处于被动接收,所以空气包中也看不到scan的参数，</p>
<p>下面画一张图让大家理解scan window和scan interval的意思。主机会在同一个频道内，听一个scan window，一个scan interval换一次频率。</p>
<p>![image-20200810221251125](./picture/SCAN I.png)</p>
<p>常用的就是这个interval和window，居然时间可以参考上面的手册。</p>
</div>
<div class="section" id="mesh">
<h3>8.4 mesh<a class="headerlink" href="#mesh" title="永久链接至标题">¶</a></h3>
<p>其实理解了上面的大部分内容，基本上mesh可以做adv相关的承载了。其实mesh有了上面的知识，基本上就可以跑了。其他的都可以暂时不用看。</p>
</div>
<div class="section" id="ble-5-0-ble-4-0">
<h3>8.4 ble 5.0 &amp; ble 4.0<a class="headerlink" href="#ble-5-0-ble-4-0" title="永久链接至标题">¶</a></h3>
<p>上面讲的只是蓝牙4.0的广播基本信息，实际上这里只讲了一小部分，还有很多内容未讲，实际上只是带大家入门，知道如何去看剩下的信息。ble5.0又引入了adv extend广播，就不止发31个字节。这些都是比较新的feature，通常安卓手机都是支持的。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../nordic/nordic_nrf5x.html" class="btn btn-neutral float-right" title="Nordic" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="Welcome to supperthomas_wiki’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; 版权所有 2020, supperthomas

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>